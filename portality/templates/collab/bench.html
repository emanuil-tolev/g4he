{% extends "base.html" %}

{% block content %}

<script type="text/javascript">

$(document).ready(function() {
    
    function _getRowData(params) {
        var data = params.data ? params.data : []
        var field = params.value_field ? params.value_field : "count"
        var df = params.date_field ? params.date_field : "time"
    
        // get a full list of the dates and process the rows for each organisation
        var dates = []
        var orgs = []
        var row_sets = {}
        for (var org in data) {
            orgs.push(org)
            var org_rows = {}
            for (var i = 0; i < data[org].length; i++) {
                var p = data[org][i]
                if ($.inArray(p[df], dates) === -1) {
                    dates.push(p[df])
                }
                org_rows[p.time] = p[field]
            }
            row_sets[org] = org_rows
        }
        
        // for each date (sorted) create a row with the relevant data from each org
        dates.sort(function(a,b){return a - b})
        orgs.sort()
        rows = []
        for (var i = 0; i < dates.length; i++) {
            row = []
            row.push(dates[i])
            for (var j = 0; j < orgs.length; j++) {
                if (dates[i] in row_sets[orgs[j]]) {
                    row.push(row_sets[orgs[j]][dates[i]])
                }
                else {
                    row.push(0)
                }
            }
            rows.push(row)
        }
        
        return {
            "rows" : rows,
            "dates" : dates,
            "orgs" : orgs
        }
    }
    
    function _getTable(params) {
        var orgs = params.orgs
        var rows = params.rows
        var value_formatter = params.value_formatter
        var date_formatter = params.date_formatter
        var table = "<table id='report_table'><thead><th>Date</th>"
        for (var i = 0; i < orgs.length; i++) {
            table += "<th>" + orgs[i] + "</th>"
        }
        table += "</thead><tbody>"
        for (var i = 0; i < rows.length; i++) {
            table += "<tr>"
            for (var j = 0; j < rows[i].length; j++) {
                var val = ""
                if (j === 0) { // this is the date field
                    val = date_formatter ? date_formatter(rows[i][j]) : rows[i][j]
                }
                else {
                    val = value_formatter && j > 0 ? value_formatter(rows[i][j]) : rows[i][j]
                }
                table += "<td>" + val + "</td>"
            }
            table += "</tr>"
        }
        table += "</tbody></table>"
        return table;
    }
    
    function numProjectsReport(benchmark) {
        // get the report data out of the benchmark response
        var data = benchmark["report"];
        
        // calculate all the row data
        var row_data = _getRowData({data:data, value_field:"count"})
        
        // generate the HTML table
        var table = _getTable({
                orgs: row_data.orgs, 
                rows: row_data.rows,
                date_formatter : dateFunctions[benchmark["parameters"]["granularity"]]
            })
        
        var header = "<h2>comparing number of projects with " + (row_data.orgs.length - 1) + " other organisations over " + row_data.dates.length + " time periods</h2>"
        
        return header + table;
    }
    
    function awardValueReport(benchmark) {
        // get the report data out of the benchmark response
        var data = benchmark["report"];
        
        // calculate all the row data
        var row_data = _getRowData({data:data, value_field:"total"})
        
        // generate the HTML table
        var table = _getTable({
                orgs: row_data.orgs,
                rows: row_data.rows, 
                value_formatter: function(data) {
                    return "Â£" + data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                },
                date_formatter : dateFunctions[benchmark["parameters"]["granularity"]]
            })
        
        var header = "<h2>comparing award values with " + (row_data.orgs.length - 1) + " other organisations over " + row_data.dates.length + " time periods</h2>"
        
        return header + table;
    }
    
    function publicationReport(benchmark) {
        // get the report data out of the benchmark response
        var data = benchmark["report"];
        
        // calculate all the row data
        var row_data = _getRowData({data:data, value_field:"count"})
        
        // generate the HTML table
        var table = _getTable({
                orgs: row_data.orgs,
                rows: row_data.rows,
                date_formatter : dateFunctions[benchmark["parameters"]["granularity"]]
            })
        
        var header = "<h2>comparing number of publications with " + (row_data.orgs.length - 1) + " other organisations over " + row_data.dates.length + " time periods</h2>"
        
        return header + table;
    }
    
    var reportFunctions = {
        "num_projects" : numProjectsReport,
        "award_value" : awardValueReport,
        "publications" : publicationReport
    }
    
    var dateFunctions = {
        "month" : function(millis) { return $.datepicker.formatDate("mm-yy", new Date(millis)) },
        "quarter" : function(millis) {
                        var d = new Date(millis)
                        var year = d.getFullYear()
                        var month = d.getMonth()
                        var q = month < 3 ? "Q1" : month < 6 ? "Q2" : month < 9 ? "Q3" : "Q4" // month is 0 indexed
                        return year + " " + q
                    },
        "year" : function(millis) { return $.datepicker.formatDate("yy", new Date(millis)) }
    }
    
    function generateReport(benchmark) {
        
        // find the report function and call it
        var fn = reportFunctions[benchmark["parameters"]["type"]]
        if (fn) {
            var frag = fn(benchmark)
            $("#report").html(frag)
            $("#report_table").tablesorter()
            $("#alternatives").show()
        }
    }
    
    $("#num_projects").change(function() {
        if (!$(this).attr("checked")) { return }
        $("#range_intro").html("For projects that start between")
    });
    
    $("#award_value").change(function() {
        if (!$(this).attr("checked")) { return }
        $("#range_intro").html("For projects that start between")
    });
    
    $("#publications").change(function() {
        if (!$(this).attr("checked")) { return }
        $("#range_intro").html("For publications published between")
    });
    
    $(".datepicker").datepicker({ dateFormat: "yy-mm-dd" });
    
    $("#generate").click(function() {
    
        var obj = {};
        
        // get the standard report parameters
        obj["mainorg"] = "{{mainorg}}";
        obj["type"] = $("input[name=report_type]:checked").val();
        obj["granularity"] = $("select[name=granularity]").val();
        var start = $("input[name=start]").val();
        if (start && start !== "") {
            obj["start"] = start;
        }
        var end = $("input[name=end]").val();
        if (end && end!== "") {
            obj["end"] = end;
        }
        
        // get the comparison information
        obj["compare_org"] = []
        $("span.org_record").each(function(i, e) {
            var org = $(e).attr("data-org")
            obj["compare_org"].push(org)
        })
        
        $.ajax({
            type: "POST",
            url: "/organisation/{{mainorg}}/benchmarking",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify(obj),
            success : generateReport
        })
    }); 
    
    $("#compare_to").select2({
        minimumInputLength: 3,
        placeholder: "select an organisation to compare yourself with",
        query: function (query) {
            $.ajax({
                type : "GET",
                data : {q : query.term},
                dataType: "json",
                url: "/organisation",
                success: function(resp) {
                    var data = {results: []}
                    for (var i = 0; i < resp.length; i++) {
                        data.results.push({id : resp[i].term, text: resp[i].term + " - " + resp[i].count + " projects"})
                    }
                    query.callback(data);
                }
            })
        }
    });
    
    $("#add_compare_org").click(function() {
        var org = $("#compare_to").val()
        var id = org.replace(/ /g,'');
        var record = "<span class='org_record' style='padding-right: 5px;' id='" + id + "' data-org='" + org + "'>" + 
                    org + "&nbsp;(<a href='#' class='remove_org' data-id='" + id + "'>x</a>)</span>"
        $("#comparing_to_list").append(record)
        
        // now re-bind the click function to the remove_org stuff
        $(".remove_org").unbind("click")
        $(".remove_org").click(function () {
            var id = $(this).attr("data-id")
            $("span[id=" + id + "]").remove()
        })
    });
    
    $("#alternatives").hide()
    
});

</script>

<h1>Benchmarking Report for {{ mainorg }}</h1>

<div class="row-fluid">
    <div class="span12"><div class="well">
    
        <h3>Report Options</h3>
        
        <p>Report on: <input type="radio" name="report_type" value="num_projects" checked="checked" id="num_projects">&nbsp;number of projects&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="radio" name="report_type" value="award_value" id="award_value">&nbsp;total amount awarded&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="radio" name="report_type" value="publications" id="publications">&nbsp;number of publications</p>
        
        <p><span id="range_intro">For projects that start between</span> <input type="text" class="datepicker" name="start" value="{% if start %}{{start}}{% endif %}"/> and <input type="text" class="datepicker" name="end" value="{% if end %}{{end}}{% endif %}"></p>
        
        <p>With granularity
        <select name="granularity">
            <option value="month">monthly</option>
            <option value="quarter" selected="selected">quarterly</option>
            <option value="year">yearly</option>
        </select></p>
    
    </div></div>
</div>

<div class="row-fluid">
    <div class="span12"><div class="well">
        <h3>Comparison Options</h3>
        
        <div class="row-fluid">
            <div class="span5" id="compare_to_org">
                <h4>Choose organisations to compare to</h4>
                <input type="text" name="compare_to" id="compare_to">
                <button id="add_compare_org" class="btn btn-success">Add &gt;&gt;</button>
            </div>
            <div class="span7" id="comparing_to_list">
                <h4>Selected organisations</h4>
            </div>
        </div>
        
        <!-- can have other compare_to blocks here for other kinds of comparison -->
    </div></div>
</div>

<button id="generate" class="btn btn-primary">Generate the report &gt;</button>

<div class="row-fluid" id="alternatives">
    <div class="span12" style="text-align: right"><a href="#" class="reporturl" data-format="csv">download as csv</a></div>
</div>

<div id="report"></div>

{% endblock %}
